name: ZTV Clean

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Generate clean ztv.m3u
        run: |
          node <<'EOF'
          const fs = require("fs");
          const https = require("https");

          const url = "https://ztv.pfy.workers.dev";

          https.get(url, res => {
            let data = "";

            res.on("data", c => data += c);
            res.on("end", () => {
              let json;
              try {
                json = JSON.parse(data);
              } catch {
                console.error("Invalid JSON");
                process.exit(1);
              }

              const list = Array.isArray(json)
                ? json
                : json.channels || json.data || json.list || Object.values(json);

              let out = "#EXTM3U\n";

              for (const ch of list) {
                const name = ch.name || "Unknown";
                const logo = ch.logo || "";
                const url  = ch.link || ch.url || ch.mpd || "";
                const lic  = ch.drmLicense || "";
                const cookie = ch.cookie || "";

                if (!url) continue;

                out += `#EXTINF:-1${logo ? ` tvg-logo="${logo}"` : ""},${name}\n`;

                if (lic.includes(":")) {
                  out += "#KODIPROP:inputstream.adaptive.license_type=clearkey\n";
                  out += `#KODIPROP:inputstream.adaptive.license_key=${lic}\n`;
                }

                if (cookie) {
                  out += `#EXTHTTP:{"cookie":"${cookie}"}\n`;
                }

                out += url + "\n";
              }

              fs.writeFileSync("ztv.m3u", out);
              console.log("ztv.m3u generated clean");
            });
          }).on("error", () => process.exit(1));
          EOF

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ztv.m3u
          git diff --cached --quiet && exit 0
          git commit -m "clean ztv.m3u"
          git push
