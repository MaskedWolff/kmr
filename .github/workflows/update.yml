name: Smart Merge IPTV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------- Download playlists --------
      - name: Download playlists from secrets
        run: |
          curl -sL "${{ secrets.SRC1 }}" -o ztv.m3u
          curl -sL "${{ secrets.SRC2 }}" -o sony.m3u
          curl -sL "${{ secrets.SRC3 }}" -o sonyliv.m3u
          curl -sL "${{ secrets.SRC4 }}" -o fancode.m3u

      # -------- Build merged playlist --------
      - name: Build merged playlist
        run: |
          echo "#EXTM3U" > new_merged.m3u

          # Normal merge for SRC1
          tail -n +2 ztv.m3u >> new_merged.m3u

          # Add group-title="Sonyliv" to all SRC2 channels
          awk '
          /^#EXTINF/ {
            if ($0 !~ /group-title=/)
              sub(/#EXTINF:-1/, "#EXTINF:-1 group-title=\"Sonyliv\"")
          }
          { print }
          ' sony.m3u | tail -n +2 >> new_merged.m3u

          # Normal merge for SRC3 & SRC4
          tail -n +2 sonyliv.m3u >> new_merged.m3u
          tail -n +2 fancode.m3u >> new_merged.m3u

      # -------- Detect change --------
      - name: Check for changes
        id: diff
        run: |
          if [ -f merged.m3u ] && cmp -s merged.m3u new_merged.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # -------- Replace only if changed --------
      - name: Update merged.m3u
        if: steps.diff.outputs.changed == 'true'
        run: mv new_merged.m3u merged.m3u

      # -------- Commit only if changed --------
      - name: Commit update
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add merged.m3u
          git commit -m "Smart auto update IPTV with Sonyliv group"
          git push
