name: ZTV Auto Update

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate ztv.m3u
        run: |
          set -e
          URL="https://ztv.pfy.workers.dev"

          echo "Downloading JSON..."
          curl -L "$URL" -o data.json

          if [ ! -s data.json ]; then
            echo "JSON download failed"
            exit 1
          fi

          echo "#EXTM3U" > ztv.m3u

          jq -r '
            def normalize:
              if type=="array" then .
              elif type=="object" then
                if has("channels") then .channels
                elif has("data") then .data
                elif has("list") then .list
                else [.[]]
                end
              else [] end;

            normalize[]
            | (.name // .title // "Unknown") as $name
            | (.logo // "") as $logo
            | (.id // "") as $id
            | (.url // .link // .mpd // "") as $url
            | (.drmScheme // "") as $drm
            | (.drmLicense // "") as $lic
            | (.cookie // "") as $cookie
            | select($url != "")

            ,
            "#EXTINF:-1 " +
            (if $id!="" then "tvg-id=\"" + $id + "\" " else "" end) +
            (if $logo!="" then "tvg-logo=\"" + $logo + "\" " else "" end) +
            "," + ($name|gsub(",";"\\,")),

            (if ($drm=="clearkey" and ($lic|contains(":")))
              then "#KODIPROP:inputstream.adaptive.license_type=clearkey",
                   "#KODIPROP:inputstream.adaptive.license_key=" + $lic
              else empty end),

            (if $cookie!=""
              then "#EXTHTTP:{\"cookie\":\"" + ($cookie|gsub("\"";"\\\"")) + "\"}"
              else empty end),

            $url
          ' data.json >> ztv.m3u

          echo "Playlist created:"
          wc -l ztv.m3u

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add ztv.m3u
          git diff --cached --quiet && exit 0

          git commit -m "Auto update ztv.m3u"
          git push
