name: Build Merged IPTV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------- Download hidden sources --------
      - name: Download playlists
        run: |
          curl -sL "${{ secrets.SRC1 }}" -o 1.m3u
          curl -sL "${{ secrets.SRC2 }}" -o 2.m3u
          curl -sL "${{ secrets.SRC3 }}" -o 3.m3u
          curl -sL "${{ secrets.SRC4 }}" -o 4.m3u

      # -------- Merge + normalize --------
      - name: Build merged.m3u
        run: |
          echo "#EXTM3U" > merged.m3u

          for f in 1.m3u 2.m3u 3.m3u 4.m3u; do
            # remove header, CRLF, blank lines
            sed '1{/^#EXTM3U/d}; s/\r$//; /^$/d' "$f" >> merged.m3u
          done

      # -------- Remove duplicate clearkey lines --------
      - name: Clean duplicate clearkey tags
        run: |
          awk '
          {
            if ($0 == "#KODIPROP:inputstream.adaptive.license_type=clearkey") {
              if (prev == $0) next
            }
            print
            prev = $0
          }
          ' merged.m3u > cleaned.m3u
          mv cleaned.m3u merged.m3u

      # -------- Commit only if changed --------
      - name: Commit merged playlist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add merged.m3u
          git diff --cached --quiet && exit 0
          git commit -m "Auto update merged IPTV (single universal file)"
          git push
